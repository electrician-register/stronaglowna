import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { Resend } from "npm:@resend/node";

serve(async (req) => {
  try {
    if (req.method !== "POST") {
      return new Response("Method not allowed", { status: 405 });
    }

    const { email, redirectTo } = await req.json();
    if (!email || !redirectTo) {
      return new Response("Missing email", { status: 400 });
    }

    const supabaseUrl = Deno.env.get("https://tfbqqduxtsacvwfigsvt.supabase.co")!;
    const serviceKey = Deno.env.get("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjY5MTg3NywiZXhwIjoyMDgyMjY3ODc3fQ.-b9qgIQNBwPy8meB07oRe4im7ACZU8NaAgydy3mSW74")!;
    const resend = new Resend(Deno.env.get("re_iJM1LN3J_Bo3mJXHmwKYTo7LURtYyXeFY")!);

    // üîê GENERUJ MAGIC LINK
    const res = await fetch(`${supabaseUrl}/auth/v1/magiclink`, {
      method: "POST",
      headers: {
        "apikey": serviceKey,
        "Authorization": `Bearer ${serviceKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email,
        redirect_to: redirectTo,
      }),
    });

    const data = await res.json();
    if (!data?.action_link) {
      console.error("Supabase auth error:", data);
      return new Response("Auth error", { status: 500 });
    }

    // ‚úâÔ∏è EMAIL PRZEZ RESEND
    await resend.emails.send({
      from: "OREP <noreply@orep.pl>",
      to: email,
      subject: "Zaloguj siƒô do OREP",
      html: `
        <h3>Logowanie OREP</h3>
        <p>Kliknij link:</p>
        <a href="${data.action_link}">Zaloguj siƒô</a>
        <p>Link wa≈ºny 60 minut</p>
      `,
    });

    return new Response("OK");
  } catch (e) {
    console.error("‚ùå ERROR", e);
    return new Response("Server error", { status: 500 });
  }
});
