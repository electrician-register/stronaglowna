<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Logowanie â€“ Supabase</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    button { padding: 12px; width: 100%; margin: 6px 0; font-size: 16px; cursor: pointer; }
    .google { background: #4285F4; color: white; border: none; }
    .email { background: #555; color: white; border: none; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); justify-content: center; align-items: center; }
    .box { background: white; padding: 20px; width: 300px; border-radius: 8px; text-align: center; }
    input { width: 100%; padding: 10px; margin-bottom: 8px; font-size: 16px; }
    /* Avatar */
    .avatar-btn { width: 48px; height: 48px; border-radius: 50%; background: #888; color: #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; border: none; }
    .avatar-btn.logged-in { background: #2b6cb0; }
    .avatar-container { display: flex; gap: 12px; align-items: center; }
    .username-label { font-size: 14px; color: #333; }
  </style>
</head>

<body>

<div class="avatar-container">
  <button id="avatarBtn" class="avatar-btn" aria-haspopup="dialog" title="Zaloguj siÄ™ / Profil">ðŸ‘¤</button>
  <div id="userLabel" class="username-label" aria-live="polite"></div>
</div>

<div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="box">
    <h3 id="loginTitle">Logowanie</h3>
    <input type="email" id="emailInput" placeholder="Email" aria-label="Email" />
    <button class="email" id="emailBtn">Zaloguj e-mailem</button>
    <button class="google" id="googleBtn">Zaloguj Google</button>
    <button id="logoutBtn" style="display:none; background:#c53030; color:#fff;">Wyloguj</button>
    <button id="closeLogin">Zamknij</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // === KONFIGURACJA SUPABASE ===
  const SUPABASE_URL = 'https://tfbqqduxtsacvwfigsvt.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTE4NzcsImV4cCI6MjA4MjI2Nzg3N30.PhuNnwzQ8cZW_UyUjCxXaYAj7xCCiTnOJVd4fUtQRD8';

  // dynamic import ESM
  let supabaseClient = null;
  try {
    const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
    if (typeof mod.createClient === 'function') {
      supabaseClient = mod.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      console.error('createClient not found in imported supabase module:', mod);
      alert('Nie moÅ¼na zaÅ‚adowaÄ‡ biblioteki Supabase (brak createClient). SprawdÅº konsolÄ™.');
    }
  } catch (err) {
    console.error('BÅ‚Ä…d podczas importu Supabase z CDN:', err);
    alert('BÅ‚Ä…d Å‚adowania biblioteki Supabase. SprawdÅº konsolÄ™/Network i uÅ¼yj poprawnego CDN.');
  }

  // UI elements
  const avatarBtn = document.getElementById('avatarBtn');
  const userLabel = document.getElementById('userLabel');
  const modal = document.getElementById('loginModal');
  const closeLogin = document.getElementById('closeLogin');
  const googleBtn = document.getElementById('googleBtn');
  const emailBtn = document.getElementById('emailBtn');
  const emailInput = document.getElementById('emailInput');
  const logoutBtn = document.getElementById('logoutBtn');

  function getInitials(nameOrEmail) {
    if (!nameOrEmail) return '';
    const name = nameOrEmail.trim();
    // jeÅ›li jest spacja - uÅ¼yj pierwszych liter imienia i nazwiska
    if (name.includes(' ')) {
      const parts = name.split(/\s+/).filter(Boolean);
      return (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
    }
    // jeÅ›li to email, weÅº pierwsze dwie litery lokalnej czÄ™Å›ci
    if (name.includes('@')) {
      const local = name.split('@')[0];
      return (local.slice(0,2)).toUpperCase();
    }
    return name.slice(0,2).toUpperCase();
  }

  function setAvatarForUser(session) {
    if (!session || !session.user) {
      avatarBtn.textContent = 'ðŸ‘¤';
      avatarBtn.classList.remove('logged-in');
      userLabel.textContent = '';
      logoutBtn.style.display = 'none';
      return;
    }
    const user = session.user;
    // sprÃ³buj pobraÄ‡ peÅ‚ne imiÄ™ z metadata
    const fullName = user.user_metadata?.full_name || user.user_metadata?.name || user.email;
    const initials = getInitials(fullName);
    avatarBtn.textContent = initials || 'U';
    avatarBtn.classList.add('logged-in');
    userLabel.textContent = user.email || '';
    logoutBtn.style.display = 'inline-block';
  }

  // Otwarcie modala przy klikniÄ™ciu avatar (jeÅ›li nie zalogowany) lub pokazanie modala/profile jeÅ›li zalogowany
  avatarBtn.addEventListener('click', async () => {
    // jeÅ›li klient nie jest dostÄ™pny - tylko otwÃ³rz modal do logowania
    if (!supabaseClient) {
      modal.style.display = 'flex';
      return;
    }
    // sprawdÅº sesjÄ™
    try {
      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session;
      // jeÅ›li nie ma sesji, otwÃ³rz modal
      if (!session) {
        modal.style.display = 'flex';
        emailInput.focus();
      } else {
        // jeÅ›li jest sesja - otwÃ³rz modal (tu moÅ¼na pokazaÄ‡ profil/wyloguj)
        modal.style.display = 'flex';
      }
    } catch (err) {
      console.error('BÅ‚Ä…d przy sprawdzaniu sesji:', err);
      modal.style.display = 'flex';
    }
  });

  closeLogin.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = 'none';
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.style.display === 'flex') {
      modal.style.display = 'none';
    }
  });

  // Google login
  googleBtn.addEventListener('click', async () => {
    if (!supabaseClient) return alert('SDK Supabase nie jest dostÄ™pny. SprawdÅº konsolÄ™.');
    try {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: 'https://orep.pl/wyszukiwarka' }
      });
      if (error) alert('BÅ‚Ä…d Google: ' + error.message);
    } catch (err) {
      console.error('BÅ‚Ä…d wywoÅ‚ania signInWithOAuth:', err);
      alert('BÅ‚Ä…d podczas logowania Google (sprawdÅº konsolÄ™).');
    }
  });

  // Email magic link
  emailBtn.addEventListener('click', async () => {
    if (!supabaseClient) return alert('SDK Supabase nie jest dostÄ™pny. SprawdÅº konsolÄ™.');
    const email = emailInput.value.trim();
    if (!email) return alert('Podaj email');

    try {
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: 'https://orep.pl/wyszukiwarka' }
      });
      if (error) alert('BÅ‚Ä…d e-mail: ' + error.message);
      else alert('SprawdÅº e-mail (link logowania)');
    } catch (err) {
      console.error('BÅ‚Ä…d wywoÅ‚ania signInWithOtp:', err);
      alert('BÅ‚Ä…d podczas wysyÅ‚ania linku (sprawdÅº konsolÄ™).');
    }
  });

  // Logout
  logoutBtn.addEventListener('click', async () => {
    if (!supabaseClient) return;
    try {
      await supabaseClient.auth.signOut();
      sessionStorage.removeItem('supabase_redirected');
      setAvatarForUser(null);
      modal.style.display = 'none';
      alert('Wylogowano');
    } catch (err) {
      console.error('BÅ‚Ä…d podczas wylogowywania:', err);
      alert('BÅ‚Ä…d podczas wylogowywania (sprawdÅº konsolÄ™).');
    }
  });

  // Observe auth state changes and update avatar (no redirect loop)
  let subscription = null;
  if (supabaseClient) {
    try {
      const { data } = supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('onAuthStateChange:', event, session?.user?.email);
        // Aktualizuj avatar na kaÅ¼de zdarzenie
        setAvatarForUser(session);

        // wczeÅ›niej logika przekierowania przy SIGNED_IN
        if (event === 'SIGNED_IN' && session?.user?.email) {
          const targetPath = '/wyszukiwarka';
          const redirectedFlag = 'supabase_redirected';
          if (location.pathname !== targetPath && !sessionStorage.getItem(redirectedFlag)) {
            sessionStorage.setItem(redirectedFlag, '1');
            window.location.href = targetPath;
          } else {
            console.log('Przekierowanie pominiÄ™te (juÅ¼ na docelowej stronie lub wczeÅ›niej przekierowano).');
          }
        }
      });
      subscription = data?.subscription;
    } catch (err) {
      console.error('BÅ‚Ä…d przy onAuthStateChange:', err);
    }

    // Initialize avatar from current session
    try {
      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session;
      setAvatarForUser(session);
    } catch (err) {
      console.error('BÅ‚Ä…d przy pobieraniu sesji:', err);
      setAvatarForUser(null);
    }
  } else {
    setAvatarForUser(null);
  }

  // Cleanup
  window.addEventListener('beforeunload', () => {
    try { sessionStorage.removeItem('supabase_redirected'); } catch (e) {}
    if (subscription && typeof subscription.unsubscribe === 'function') subscription.unsubscribe();
  });
});
</script>

</body>
</html>