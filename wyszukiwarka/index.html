<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ogólnopolski Rejestr Elektryków</title>

<style>
:root{
  --primary:#0B5FA5;
  --bg:#f4f6f8;
  --card:#ffffff;
  --text:#1c1c1e;
  --muted:#6b7280;
  --line:#d1d5db;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:var(--bg);
}

/* HEADER */
header{
  background:linear-gradient(135deg,#0B5FA5,#083f6b);
  color:white;
  padding:30px 20px;
}
.header-wrap{
  max-width:1100px;
  margin:auto;
}

/* SEARCH */
main{
  max-width:1100px;
  margin:-30px auto 40px;
  padding:0 15px;
}
.search-card{
  background:white;
  border-radius:12px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
}

/* JEDNOLITA WYSOKOŚĆ */
.search-card select,
.search-card button {
  height: 48px;
  font-size: 16px;
  padding: 0 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

.search-card label {
  display: block;
  margin-bottom: 10px;
}

.search-card label span {
  margin-left: 3px;
}

select,button{
  width:100%;
  margin-top:10px;
}

button{
  background:var(--primary);
  color:white;
  border:none;
  cursor:pointer;
  transition: background 0.3s;
}

button:hover {
  background:#083f6b;
}

button:disabled {
  background:#ccc;
  cursor:not-allowed;
}

.loading {
  opacity: 0.7;
  pointer-events: none;
}

sup a {
  text-decoration: none;
  font-size: 0.7em;
  color: #0077ff;
  margin:auto;
}

sup a:hover {
  text-decoration: underline;
}

.przypis {
  margin: 30px 20px;
  padding: 10px 15px;
  background: #f6f8fa;
  border-left: 4px solid #0077ff;
  border-radius: 6px;
  font-size: 10px;
}

/* RESULTS CARDS */
#results{
  margin-top:20px;
}

.card{
  display:grid;
  grid-template-columns: 70px 1fr 160px 120px;
  padding:14px;
  margin-bottom:12px;
  border-radius:10px;
  background:white;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition: transform 0.2s;
}

.card:hover{
  transform: translateY(-2px);
  box-shadow:0 6px 16px rgba(0,0,0,.12);
}

.lp{
  font-weight:bold;
  text-align:center;
  align-self:center;
}

.person .name{
  font-weight:bold;
  font-size:16px;
  margin-bottom:5px;
}
.person .small{
  font-size:14px;
  color:var(--muted);
}

.stars{
  font-size:12px;
  color:#f5b400;
  text-align:center;
}

.status{
  font-size:12px;
  color:#16a34a;
  text-align:center;
}

/* PAGINATION */
#pagination button {
  width:auto;
  padding:10px 20px;
  margin:0 5px;
  display:inline-block;
}

/* LOADING SPINNER */
.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #0B5FA5;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin:20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ERROR MESSAGE */
.error {
  background:#fee;
  border:1px solid #f99;
  color:#c00;
  padding:15px;
  border-radius:8px;
  text-align:center;
  margin:20px 0;
}

/* --- RESPONSYWNE GRIDY --- */
@media (max-width: 700px) {
  .card {
    display: block;
    grid-template-columns: none;
  }

  .card > div {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    margin-bottom: 4px;
  }

  .card .person {
    flex-direction: column;
  }

  .stars, .status {
    margin-top: 5px;
  }

  .lp {
    margin-bottom: 5px;
    text-align: left;
  }
  
  #pagination button {
    display:block;
    width:100%;
    margin:10px 0;
  }
}
</style>
</head>

<body>

<header>
  <div class="header-wrap">
    <h1>Ogólnopolski Rejestr Elektryków</h1>
    <p>Oficjalna wyszukiwarka certyfikowanych elektryków</p>
  </div>
</header>

<main>
<div class="search-card">
  <label>
    Województwo <span style="color:orange;">*</span>
    <select id="wojewodztwo">
      <option value="">Wybierz województwo</option>
    </select>
  </label>

  <label>
    Miasto <span style="color:orange;">*</span>
    <select id="miasto" disabled>
      <option value="">Najpierw wybierz województwo</option>
    </select>
  </label>

  <label>
    Uprawnienia
    <select id="gwiazdki">
      <option value="">Wszystkie uprawnienia</option>
      <option value="⭐">⭐</option>
      <option value="⭐⭐">⭐⭐</option>
      <option value="⭐⭐⭐">⭐⭐⭐</option>
    </select>
  </label>

  <label>
    Status
    <select id="status">
      <option value="">Wszystkie statusy</option>
      <option value="✅">✅ Zweryfikowany</option>
      <option value="⌛">⌛ Weryfikacja w toku</option>
      <option value="❌">❌ Nieudostępnione</option>
    </select>
  </label>

  <label style="display:block;margin-top:10px;">
    <input type="checkbox" id="show_contact">
    Pokaż tylko elektryków z możliwością kontaktu
  </label>

  <button id="szukaj">Szukaj</button>
</div>

<div id="results"></div>
<div id="pagination" style="margin-top:20px;text-align:center"></div>
</main>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://tfbqqduxtsacvwfigsvt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTE4NzcsImV4cCI6MjA4MjI2Nzg3N30.PhuNnwzQ8cZW_UyUjCxXaYAj7xCCiTnOJVd4fUtQRD8"
)

const woj = document.getElementById("wojewodztwo")
const miasto = document.getElementById("miasto")
const results = document.getElementById("results")
const gwiazdki = document.getElementById("gwiazdki")
const status = document.getElementById("status")
const show_contact = document.getElementById("show_contact")
const szukajBtn = document.getElementById("szukaj")

let currentPage = 1
const pageSize = 10
let totalCount = 0

// --- Ładowanie województw ---
async function loadWoj() {
  try {
    const { data, error } = await supabase
      .from("wojewodztwa")
      .select("id,nazwa")
      .order("nazwa")
    
    if (error) throw error;
    
    woj.innerHTML = '<option value="">Wybierz województwo</option>'
    data.forEach(w => {
      const o = document.createElement("option")
      o.value = String(w.id)
      o.textContent = w.nazwa
      woj.appendChild(o)
    })
  } catch (err) {
    console.error("Błąd ładowania województw:", err)
    woj.innerHTML = '<option value="">Błąd ładowania danych</option>'
    showError(results, "Nie udało się załadować listy województw")
  }
}

// --- Ładowanie miast ---
woj.addEventListener("change", async () => {
  const selectedWojId = woj.value
  
  miasto.innerHTML = '<option value="">Ładowanie...</option>'
  miasto.disabled = true
  
  if (!selectedWojId) {
    miasto.innerHTML = '<option value="">Najpierw wybierz województwo</option>'
    miasto.disabled = true
    return
  }

  try {
    // Spróbuj różnych nazw kolumn - dostosuj do swojej struktury bazy
    let query = supabase
      .from("miasta")
      .select("id,nazwa")
      .order("nazwa")
    
    // Próba 1: wojewodztwo_id
    query = query.eq("wojewodztwo_id", selectedWojId)
    
    let { data, error } = await query
    
    if (error || !data || data.length === 0) {
      // Próba 2: woj_id
      const response2 = await supabase
        .from("miasta")
        .select("id,nazwa")
        .eq("woj_id", selectedWojId)
        .order("nazwa")
      
      if (response2.error || !response2.data || response2.data.length === 0) {
        // Próba 3: wojewodztwo
        const response3 = await supabase
          .from("miasta")
          .select("id,nazwa")
          .eq("wojewodztwo", selectedWojId)
          .order("nazwa")
        
        if (response3.error) {
          throw new Error("Nie znaleziono odpowiedniej kolumny w tabeli miasta")
        }
        
        data = response3.data
      } else {
        data = response2.data
      }
    }

    miasto.innerHTML = '<option value="">Wybierz miasto</option>'
    
    if (data && data.length > 0) {
      data.forEach(m => {
        const o = document.createElement("option")
        o.value = String(m.id)
        o.textContent = m.nazwa
        miasto.appendChild(o)
      })
      miasto.disabled = false
    } else {
      miasto.innerHTML = '<option value="">Brak miast w wybranym województwie</option>'
      miasto.disabled = true
    }
  } catch (err) {
    console.error("Błąd ładowania miast:", err)
    miasto.innerHTML = '<option value="">Błąd ładowania miast</option>'
    miasto.disabled = true
    showError(results, `Nie udało się załadować miast: ${err.message}`)
  }
})

// --- Wyświetlanie błędu ---
function showError(element, message) {
  element.innerHTML = `<div class="error">${message}</div>`
}

// --- Wyświetlanie spinnera ---
function showSpinner(element) {
  element.innerHTML = '<div class="spinner"></div>'
}

// --- Render pagination ---
function renderPagination(hasMore) {
  const p = document.getElementById("pagination")
  p.innerHTML = ""

  if (totalCount === 0) return

  const totalPages = Math.ceil(totalCount / pageSize)
  const startItem = (currentPage - 1) * pageSize + 1
  const endItem = Math.min(currentPage * pageSize, totalCount)

  // Informacja o wynikach
  const info = document.createElement("div")
  info.style.marginBottom = "10px"
  info.style.color = "#666"
  info.innerHTML = `Wyświetlono ${startItem}-${endItem} z ${totalCount} wyników`
  p.appendChild(info)

  if (currentPage > 1) {
    const prev = document.createElement("button")
    prev.textContent = "← Poprzednia"
    prev.onclick = () => {
      currentPage--
      search()
    }
    p.appendChild(prev)
  }

  if (hasMore && currentPage < totalPages) {
    const next = document.createElement("button")
    next.textContent = "Następna →"
    next.style.marginLeft = "10px"
    next.onclick = () => {
      currentPage++
      search()
    }
    p.appendChild(next)
  }
}

// --- Szukanie ---
async function search() {
  // Walidacja
  if (!woj.value) {
    showError(results, "Wybierz województwo aby wyszukać")
    return
  }

  if (!miasto.value) {
    showError(results, "Wybierz miasto aby wyszukać")
    return
  }

  showSpinner(results)
  szukajBtn.disabled = true
  szukajBtn.textContent = "Szukam..."

  try {
    // Pobierz wszystkie kolumny potrzebne do filtrowania
    let query = supabase
      .from("tabela_elektrykow")
      .select("id,imie,nazwisko,gwiazdki,status,telefon,email,wojewodztwo,miasto,show_contact", { 
        count: "exact" 
      })

    // Filtrowanie
    if (woj.value) query = query.eq("wojewodztwo", woj.value)
    if (miasto.value) query = query.eq("miasto", miasto.value)
    
    // WAŻNE: Teraz gwiazdki są porównywane jako tekst
    if (gwiazdki.value) query = query.eq("gwiazdki", gwiazdki.value)
    
    if (status.value) query = query.eq("status", status.value)
    if (show_contact.checked) query = query.eq("show_contact", true)

    const from = (currentPage - 1) * pageSize
    const to = from + pageSize - 1

    const { data, error, count } = await query.range(from, to)

    if (error) throw error;

    totalCount = count || 0

    if (!data || data.length === 0) {
      results.innerHTML = '<div style="text-align:center;padding:30px;color:#666;">Nie znaleziono elektryków spełniających kryteria wyszukiwania</div>'
      document.getElementById("pagination").innerHTML = ""
      return
    }

    results.innerHTML = ""
    data.forEach((e, i) => {
      const d = document.createElement("div")
      d.className = "card"
      
      d.innerHTML = `
        <div class="lp">${from + i + 1}</div>
        <div class="person">
          <div class="name">${e.imie} ${e.nazwisko} ${e.gwiazdki || ''}</div>
          <div class="small">Status: ${e.status || 'Nie podano'}</div>
          ${e.telefon ? `<div class="small">Tel: ${e.telefon}</div>` : ''}
          ${e.email ? `<div class="small">Email: ${e.email}</div>` : ''}
        </div>
        <div>
          <button onclick="window.location.href='/profil/index.html?id=${e.id}'">
            Zobacz profil
          </button>
        </div>
      `
      results.appendChild(d)
    })

    renderPagination(to + 1 < totalCount)
  } catch (err) {
    console.error("Błąd wyszukiwania:", err)
    showError(results, "Wystąpił błąd podczas wyszukiwania. Spróbuj ponownie.")
  } finally {
    szukajBtn.disabled = false
    szukajBtn.textContent = "Szukaj"
  }
}

// --- Funkcja do debugowania struktury tabeli ---
async function debugTableStructure() {
  try {
    // Sprawdź strukturę tabeli elektryków
    const { data: sampleData, error: sampleError } = await supabase
      .from("tabela_elektrykow")
      .select("*")
      .limit(1)
    
    if (!sampleError && sampleData && sampleData.length > 0) {
      console.log("Przykładowy rekord z tabeli elektryków:", sampleData[0])
      console.log("Typ pola gwiazdki:", typeof sampleData[0].gwiazdki, "Wartość:", sampleData[0].gwiazdki)
    }
    
    // Sprawdź strukturę tabeli miast
    const { data: miastaSample, error: miastaError } = await supabase
      .from("miasta")
      .select("*")
      .limit(1)
    
    if (!miastaError && miastaSample && miastaSample.length > 0) {
      console.log("Przykładowy rekord z tabeli miast:", miastaSample[0])
    }
  } catch (err) {
    console.error("Błąd debugowania:", err)
  }
}

// --- Inicjalizacja ---
document.addEventListener("DOMContentLoaded", async () => {
  // Uruchom debugowanie struktury
  await debugTableStructure()
  
  await loadWoj()
  
  // Event listener dla przycisku szukaj
  szukajBtn.addEventListener("click", () => {
    currentPage = 1
    search()
  })
  
  // Event listener dla klawisza Enter
  document.querySelectorAll("select").forEach(select => {
    select.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        currentPage = 1
        search()
      }
    })
  })
  
  // Auto-wyszukiwanie po zmianie miasta
  miasto.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
  
  // Auto-wyszukiwanie po zmianie innych filtrów
  gwiazdki.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
  
  status.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
  
  show_contact.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
})

// --- Funkcja pomocnicza do czyszczenia tekstu z gwiazdek ---
function cleanStarText(text) {
  if (!text) return 0
  // Liczy tylko gwiazdki emoji (⭐)
  const starsCount = (text.match(/⭐/g) || []).length
  return starsCount
}
</script>

<p id="p1" class="przypis"><br>
  <sup>*</sup><b>Opis dotyczący gwiazdek oraz posiadanego statusu:</b><br><br>⭐ elektryk posiada uprawnienia Eksploatacja.<br><br> ⭐⭐ elektryk posiada uprawnienia Eksploatacja wraz z prawem wykonywania pomiarów ochronnych.<br><br>⭐⭐⭐ elektryk posiada wszystkie możliwe uprawnienia z prawem do prowadzenia Dozoru instalacji i sieci energetycznych.<br><br> ✅ Elektryk udostępnił uprawnienia i został pozytywnie zweryfikowany.<br><br> ⌛ Elektryk udostępnił uprawnienia i oczekuje na weryfikację.<br><br>❌ Elektryk <b>NIE</b> udostępnił uprawnień do weryfikacji lub <b>NIE</b> zostały wydane przez komisję do tego uprawnioną zgodnie z URE.<br></p>

</body>
</html>
