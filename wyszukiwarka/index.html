<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ogólnopolski Rejestr Elektryków</title>

<style>
/* ... cały CSS bez zmian ... */
</style>
</head>

<body>

<header>
  <div class="header-wrap">
    <h1>Ogólnopolski Rejestr Elektryków</h1>
    <p>Oficjalna wyszukiwarka certyfikowanych elektryków</p>
  </div>
</header>

<main>
<div class="search-card">
  <label>
    Województwo <span style="color:orange;">*</span>
    <select id="wojewodztwo">
      <option value="">Wybierz województwo</option>
    </select>
  </label>

  <label>
    Miasto <span style="color:orange;">*</span>
    <select id="miasto" disabled>
      <option value="">Najpierw wybierz województwo</option>
    </select>
  </label>

  <label>
    Uprawnienia
    <select id="gwiazdki">
      <option value="">Wszystkie uprawnienia</option>
      <option value="⭐">⭐</option>
      <option value="⭐⭐">⭐⭐</option>
      <option value="⭐⭐⭐">⭐⭐⭐</option>
    </select>
  </label>

  <label>
    Status
    <select id="status">
      <option value="">Wszystkie statusy</option>
      <option value="verified" style="color:#16a34a;font-weight:bold;">✔️ Zweryfikowany</option>
      <option value="pending" style="color:#f97316;font-weight:bold;">⌛ Weryfikacja w toku</option>
      <option value="unconfirmed" style="color:#dc2626;font-weight:bold;">❌ Status nie potwierdzony</option>
    </select>
  </label>

  <label style="display:block;margin-top:10px;">
    <input type="checkbox" id="show_contact">
    Pokaż tylko elektryków z możliwością kontaktu
  </label>

  <button id="szukaj">Szukaj</button>
</div>

<div id="results"></div>
<div id="pagination" style="margin-top:20px;text-align:center"></div>
</main>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://tfbqqduxtsacvwfigsvt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTE4NzcsImV4cCI6MjA4MjI2Nzg3N30.PhuNnwzQ8cZW_UyUjCxXaYAj7xCCiTnOJVd4fUtQRD8"
)

const woj = document.getElementById("wojewodztwo")
const miasto = document.getElementById("miasto")
const results = document.getElementById("results")
const gwiazdki = document.getElementById("gwiazdki")
const statusSelect = document.getElementById("status")
const show_contact = document.getElementById("show_contact")
const szukajBtn = document.getElementById("szukaj")

let currentPage = 1
const pageSize = 10
let totalCount = 0

// --- Funkcja debugowania struktury tabel ---
async function debugTables() {
  console.log("=== DEBUGOWANIE STRUKTURY TABEL ===")
  
  try {
    // Sprawdź strukturę tabeli wojewodztwa
    const { data: wojData, error: wojError } = await supabase
      .from("wojewodztwa")
      .select("*")
      .limit(2)
    
    if (!wojError && wojData && wojData.length > 0) {
      console.log("Struktura tabeli 'wojewodztwa':", wojData[0])
      console.log("ID pierwszego województwa:", wojData[0].id)
      console.log("Nazwa pierwszego województwa:", wojData[0].nazwa)
    } else {
      console.error("Błąd pobierania wojewodztw:", wojError)
    }
    
    // Sprawdź strukturę tabeli miasta
    const { data: miastaData, error: miastaError } = await supabase
      .from("miasta")
      .select("*")
      .limit(5)
    
    if (!miastaError && miastaData && miastaData.length > 0) {
      console.log("Struktura tabeli 'miasta' (pierwsze 5 rekordów):", miastaData)
      console.log("Kolumny w tabeli 'miasta':", Object.keys(miastaData[0]))
      
      // Sprawdź jakie wartości są w kolumnie z województwem
      const wojColumnName = Object.keys(miastaData[0]).find(key => 
        key.toLowerCase().includes('woj') || 
        key.toLowerCase().includes('id_woj') ||
        key.toLowerCase().includes('wojewodztwo')
      )
      
      if (wojColumnName) {
        console.log(`Znaleziono kolumnę z województwem: ${wojColumnName}`)
        console.log(`Przykładowa wartość: ${miastaData[0][wojColumnName]}`)
      } else {
        console.log("Nie znaleziono kolumny z województwem w tabeli miasta")
      }
    } else {
      console.error("Błąd pobierania miast:", miastaError)
    }
    
  } catch (err) {
    console.error("Błąd debugowania:", err)
  }
}

// --- Ładowanie województw ---
async function loadWoj() {
  try {
    console.log("Ładowanie województw z tabeli 'wojewodztwa'...")
    const { data, error } = await supabase
      .from("wojewodztwa")
      .select("id,nazwa")
      .order("nazwa")
    
    if (error) {
      console.error("Błąd pobierania województw:", error)
      throw error;
    }
    
    console.log(`Pobrano ${data.length} województw`)
    
    woj.innerHTML = '<option value="">Wybierz województwo</option>'
    data.forEach(w => {
      const o = document.createElement("option")
      o.value = String(w.id)
      o.textContent = w.nazwa
      woj.appendChild(o)
    })
    
    console.log("Województwa załadowane pomyślnie")
  } catch (err) {
    console.error("Błąd ładowania województw:", err)
    woj.innerHTML = '<option value="">Błąd ładowania danych</option>'
    showError(results, "Nie udało się załadować listy województw")
  }
}

// --- Ładowanie miast ---
woj.addEventListener("change", async () => {
  const selectedWojId = woj.value
  
  console.log(`Wybrano województwo ID: ${selectedWojId}`)
  
  miasto.innerHTML = '<option value="">Ładowanie miast...</option>'
  miasto.disabled = true
  
  if (!selectedWojId) {
    miasto.innerHTML = '<option value="">Najpierw wybierz województwo</option>'
    miasto.disabled = true
    return
  }

  try {
    console.log(`Pobieranie miast z tabeli 'miasta' dla województwa ID: ${selectedWojId}`)
    
    // Najpierw spróbujmy najbardziej prawdopodobną nazwę kolumny
    let { data, error } = await supabase
      .from("miasta")
      .select("id,nazwa,wojewodztwo_id")
      .eq("wojewodztwo_id", selectedWojId)
      .order("nazwa")
    
    // Jeśli nie działa, spróbuj innych nazw
    if (error || !data || data.length === 0) {
      console.log("Próba z innymi nazwami kolumn...")
      const possibleColumns = ['woj_id', 'wojewodztwo', 'id_wojewodztwo', 'id_woj']
      
      for (const column of possibleColumns) {
        const response = await supabase
          .from("miasta")
          .select("id,nazwa")
          .eq(column, selectedWojId)
          .order("nazwa")
        
        if (!response.error && response.data && response.data.length > 0) {
          data = response.data
          error = null
          console.log(`Znaleziono miasta z kolumną: ${column}`)
          break
        }
      }
    }
    
    if (error) throw error
    
    miasto.innerHTML = '<option value="">Wybierz miasto</option>'
    
    if (data && data.length > 0) {
      console.log(`Pobrano ${data.length} miast`)
      data.forEach(m => {
        const o = document.createElement("option")
        o.value = String(m.id)
        o.textContent = m.nazwa
        miasto.appendChild(o)
      })
      miasto.disabled = false
    } else {
      console.log("Brak miast dla wybranego województwa")
      miasto.innerHTML = '<option value="">Brak miast w wybranym województwie</option>'
      miasto.disabled = true
    }
    
  } catch (err) {
    console.error("Błąd ładowania miast:", err)
    miasto.innerHTML = '<option value="">Błąd ładowania miast</option>'
    miasto.disabled = true
    showError(results, `Nie udało się załadować listy miast`)
  }
})

// --- Wyświetlanie błędu ---
function showError(element, message) {
  element.innerHTML = `<div class="error">${message}</div>`
}

// --- Wyświetlanie spinnera ---
function showSpinner(element) {
  element.innerHTML = '<div class="spinner"></div>'
}

// --- Render pagination ---
function renderPagination(hasMore) {
  const p = document.getElementById("pagination")
  p.innerHTML = ""

  if (totalCount === 0) return

  const totalPages = Math.ceil(totalCount / pageSize)
  const startItem = (currentPage - 1) * pageSize + 1
  const endItem = Math.min(currentPage * pageSize, totalCount)

  // Informacja o wynikach
  const info = document.createElement("div")
  info.style.marginBottom = "10px"
  info.style.color = "#666"
  info.innerHTML = `Wyświetlono ${startItem}-${endItem} z ${totalCount} wyników`
  p.appendChild(info)

  if (currentPage > 1) {
    const prev = document.createElement("button")
    prev.textContent = "← Poprzednia"
    prev.onclick = () => {
      currentPage--
      search()
    }
    p.appendChild(prev)
  }

  if (hasMore && currentPage < totalPages) {
    const next = document.createElement("button")
    next.textContent = "Następna →"
    next.style.marginLeft = "10px"
    next.onclick = () => {
      currentPage++
      search()
    }
    p.appendChild(next)
  }
}

// --- Formatowanie statusu ---
function formatStatus(statusValue) {
  // Jeśli status jest już w formacie emoji, użyj go bezpośrednio
  if (statusValue === '✅' || statusValue === 'verified') {
    return { 
      text: '✔️ Zweryfikowany', 
      className: 'status-verified',
      style: 'color:#16a34a;font-weight:bold;'
    }
  } else if (statusValue === '⌛' || statusValue === 'pending') {
    return { 
      text: '⌛ Elektryk w trakcie weryfikacji', 
      className: 'status-pending',
      style: 'color:#f97316;font-weight:bold;'
    }
  } else if (statusValue === '❌' || statusValue === 'unconfirmed') {
    return { 
      text: '❌ Status nie potwierdzony', 
      className: 'status-unconfirmed',
      style: 'color:#dc2626;font-weight:bold;'
    }
  } else {
    return { 
      text: statusValue || 'Nie określono', 
      className: '',
      style: ''
    }
  }
}

// --- Sprawdzenie czy pokazać dane kontaktowe ---
function shouldShowContact(electrician) {
  // Sprawdź czy elektryk ma status zweryfikowany
  const isVerified = electrician.status === '✅' || electrician.status === 'verified'
  
  // Sprawdź czy ma ustawione show_contact
  const hasContactPermission = electrician.show_contact === true
  
  return isVerified && hasContactPermission && (electrician.telefon || electrician.email)
}

// --- Szukanie ---
async function search() {
  // Walidacja
  if (!woj.value) {
    showError(results, "Wybierz województwo aby wyszukać")
    return
  }

  if (!miasto.value) {
    showError(results, "Wybierz miasto aby wyszukać")
    return
  }

  showSpinner(results)
  szukajBtn.disabled = true
  szukajBtn.textContent = "Szukam..."

  try {
    let query = supabase
      .from("tabela_elektrykow")
      .select("id,imie,nazwisko,gwiazdki,status,telefon,email,wojewodztwo,miasto,show_contact", { 
        count: "exact" 
      })

    // Filtrowanie
    if (woj.value) query = query.eq("wojewodztwo", woj.value)
    if (miasto.value) query = query.eq("miasto", miasto.value)
    
    // Filtrowanie po gwiazdkach (jako tekst)
    if (gwiazdki.value) query = query.eq("gwiazdki", gwiazdki.value)
    
    // Filtrowanie po statusie - obsługa różnych formatów
    if (statusSelect.value) {
      if (statusSelect.value === 'verified') {
        query = query.eq("status", '✅')
      } else if (statusSelect.value === 'pending') {
        query = query.eq("status", '⌛')
      } else if (statusSelect.value === 'unconfirmed') {
        query = query.eq("status", '❌')
      } else {
        query = query.eq("status", statusSelect.value)
      }
    }
    
    if (show_contact.checked) query = query.eq("show_contact", true)

    const from = (currentPage - 1) * pageSize
    const to = from + pageSize - 1

    const { data, error, count } = await query.range(from, to)

    if (error) throw error;

    totalCount = count || 0

    if (!data || data.length === 0) {
      results.innerHTML = '<div style="text-align:center;padding:30px;color:#666;">Nie znaleziono elektryków spełniających kryteria wyszukiwania</div>'
      document.getElementById("pagination").innerHTML = ""
      return
    }

    results.innerHTML = ""
    data.forEach((e, i) => {
      const d = document.createElement("div")
      d.className = "card"
      
      // Formatowanie statusu
      const statusInfo = formatStatus(e.status)
      
      // Sprawdź czy pokazać dane kontaktowe
      const showContactInfo = shouldShowContact(e)
      
      d.innerHTML = `
        <div class="lp">${from + i + 1}</div>
        <div class="person">
          <div class="name">${e.imie} ${e.nazwisko} ${e.gwiazdki || ''}</div>
          <div class="small ${statusInfo.className}" style="${statusInfo.style}">${statusInfo.text}</div>
          ${showContactInfo ? `
            <div class="contact-info">
              ${e.telefon ? `<div><strong>Telefon:</strong> ${e.telefon}</div>` : ''}
              ${e.email ? `<div><strong>Email:</strong> ${e.email}</div>` : ''}
            </div>
          ` : ''}
        </div>
        <div>
          <button onclick="window.location.href='/profil/index.html?id=${e.id}'">
            Zobacz profil
          </button>
        </div>
      `
      results.appendChild(d)
    })

    renderPagination(to + 1 < totalCount)
  } catch (err) {
    console.error("Błąd wyszukiwania:", err)
    showError(results, "Wystąpił błąd podczas wyszukiwania. Spróbuj ponownie.")
  } finally {
    szukajBtn.disabled = false
    szukajBtn.textContent = "Szukaj"
  }
}

// --- Inicjalizacja ---
document.addEventListener("DOMContentLoaded", async () => {
  // KOMENTUJEMY LUB USUWAMY WYWOŁANIE DEBUGOWANIA
  // await debugTables()  // TO JEST PROBLEM - KOMENTUJEMY
  
  await loadWoj()
  
  // Event listener dla przycisku szukaj
  szukajBtn.addEventListener("click", () => {
    currentPage = 1
    search()
  })
  
  // Event listener dla klawisza Enter
  document.querySelectorAll("select").forEach(select => {
    select.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        currentPage = 1
        search()
      }
    })
  })
  
  // Auto-wyszukiwanie po zmianie miasta
  miasto.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
  
  // Auto-wyszukiwanie po zmianie innych filtrów
  gwiazdki.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
  
  statusSelect.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
  
  show_contact.addEventListener("change", () => {
    if (miasto.value && woj.value) {
      currentPage = 1
      search()
    }
  })
})
</script>

<p id="p1" class="przypis"><br>
  <sup>*</sup><b>Opis dotyczący gwiazdek oraz posiadanego statusu:</b><br><br>⭐ elektryk posiada uprawnienia Eksploatacja.<br><br> ⭐⭐ elektryk posiada uprawnienia Eksploatacja wraz z prawem wykonywania pomiarów ochronnych.<br><br>⭐⭐⭐ elektryk posiada wszystkie możliwe uprawnienia z prawem do prowadzenia Dozoru instalacji i sieci energetycznych.<br><br> <span class="status-verified">✔️ Zweryfikowany</span> - Elektryk udostępnił uprawnienia i został pozytywnie zweryfikowany. Dane kontaktowe są widoczne.<br><br> <span class="status-pending">⌛ Elektryk w trakcie weryfikacji</span> - Elektryk udostępnił uprawnienia i oczekuje na weryfikację.<br><br> <span class="status-unconfirmed">❌ Status nie potwierdzony</span> - Elektryk <b>NIE</b> udostępnił uprawnień do weryfikacji lub <b>NIE</b> zostały wydane przez komisję do tego uprawnioną zgodnie z URE.<br></p>

</body>
</html>
