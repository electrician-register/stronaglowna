<!DOCTYPE html>
<html lang="pl">
<head>
<!-- Meta tagi - wype≈Çni JavaScript -->
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:image" content="https://orep.pl/oreppl.jpg">
<meta property="og:type" content="website">
<meta property="og:url" content="">
<meta name="robots" content="noindex, nofollow">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profil elektryka - OREP.pl</title>

<style>
body {
  margin:0;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#f4f6f8;
  color:#333;
}

header {
  background: linear-gradient(135deg, #0B5FA5, #0f72c1);
  color:#fff;
  text-align:center;
  padding:30px 20px;
}

header h1 {
  font-size:2.6rem;
  margin:0 0 10px;
}

header p {
  font-size:1.2rem;
  max-width:700px;
  margin:0 auto 25px;
  opacity:0.9;
  color:#f4f4f5;
}

/* === WIZYT√ìWKA ELEKTRYKA === */
.about-box {
  margin:30px auto;
  padding:25px 30px;
  max-width:720px;
  background:#f8fafc;
  border-left:5px solid #0B5FA5;
  border-radius:10px;
  text-align:left;
}

.about-box h3 {
  margin:0 0 12px;
  font-size:18px;
  font-weight:700;
  color:#0B5FA5;
}

#opis {
  font-size:16.5px;
  line-height:1.7;
  color:#1f2937;
}

/* Stylowanie dla sformatowanego tekstu z Quilla */
#opis strong, #opis b {
  font-weight: 700;
}

#opis em, #opis i {
  font-style: italic;
}

#opis u {
  text-decoration: underline;
}

#opis a {
  color: #0f72c1;
  text-decoration: none;
}

#opis a:hover {
  text-decoration: underline;
}

#opis ul, #opis ol {
  padding-left: 20px;
  margin: 10px 0;
}

#opis li {
  margin-bottom: 5px;
}

/* PRZYCISK UDOSTƒòPNIJ */
.share-btn {
  background-color:#0B5FA5;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:12px 20px;
  font-size:16px;
  cursor:pointer;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:8px;
  transition:background 0.3s ease;
}

.share-btn:hover {
  background-color:#094c84;
}

/* LINIA POD HEADEREM */
.header-line {
  width:100%;
  height:56px;
  font-size:24px;
  letter-spacing:3px;
  background:#0f172a;
  display:flex;
  align-items:center;
  justify-content:center;
}

.header-line span {
  font-weight:700;
  font-size:24px;
  color:#fff;
  line-height:1;
}

/* SEKCJE */
section {
  max-width:900px;
  margin:40px auto;
  background:#fff;
  padding:30px;
  border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
  text-align:center;
}

/* STATUS */
.badge {
  display:inline-block;
  padding:6px 14px;
  color:#fff;
  border-radius:20px;
  font-weight:600;
  margin-bottom:20px;
}

.status-ok { background:#16a34a; }
.status-wait { background:#f59e0b; }
.status-no { background:#dc2626; }

.hidden {
  display:none;
}

/* ≈ÅADOWANIE */
.loader {
  border:4px solid #f3f3f3;
  border-top:4px solid #0B5FA5;
  border-radius:50%;
  width:40px;
  height:40px;
  animation:spin 1s linear infinite;
  margin:30px auto;
}

@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}
</style>
</head>

<body>

<header>
  <h1 id="heroName">Profil elektryka</h1>
  <p id="heroDesc">Profil w Centralnym Rejestrze Elektryk√≥w</p>
</header>

<div class="header-line">
  <span id="gwiazdkiLine"></span>
</div>

<!-- Sekcja ≈Çadowania -->
<section id="loading" class="hidden">
  <div class="loader"></div>
  <p>≈Åadowanie profilu...</p>
</section>

<!-- Sekcja profilu -->
<section id="profil" class="hidden">
  <span id="status" class="badge"></span>

  <div class="about-box">
    <h3>‚ö° Zakres us≈Çug / O mnie</h3>
    <div id="opis"></div>
  </div>

  <p><strong>Email:</strong> <span id="email"></span></p>
  <p><strong>Telefon:</strong> <span id="telefon"></span></p>

  <p>
    <button type="button" id="shareProfileBtn" class="share-btn">
      üîó Udostƒôpnij profil
    </button>
  </p>
</section>

<!-- Sekcja b≈Çƒôdu/braku -->
<section id="brak" class="hidden">
  <h2 id="errorTitle">Brak wynik√≥w</h2>
  <p id="errorMessage">Nie znaleziono elektryka.</p>
</section>

<script type="module">
// ===== KONFIGURACJA =====
const API_URL = "https://tfbqqduxtsacvwfigsvt.supabase.co/functions/v1/get-elektryk-profile";

// ===== FUNKCJE POMOCNICZE =====
function cleanOpis(html) {
  if (!html) return "";
  
  let cleaned = html
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
    .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
    .replace(/on\w+="[^"]*"/gi, '')
    .replace(/on\w+='[^']*'/gi, '')
    .replace(/javascript:/gi, '');
  
  cleaned = cleaned.replace(/<a\s+(.*?)>/gi, (match, attrs) => {
    if (!attrs.includes('target=')) {
      return `<a ${attrs} target="_blank">`;
    }
    return match;
  });
  
  return cleaned;
}

// ===== MAPOWANIE STATUS√ìW =====
const statusMap = {
  "‚úÖ": { text: "Status ELEKTRYKA - zweryfikowany üôÇ", class: "status-ok" },
  "‚åõ": { text: "Status ELEKTRYKA - w trakcie weryfikacji üò¥", class: "status-wait" },
  "‚ùå": { text: "Status ELEKTRYKA - aktualnie brak weryfikacji üòï", class: "status-no" },
  "": { text: "Status nieustalony", class: "status-wait" }
};

// ===== FUNKCJA ≈ÅADUJƒÑCA PROFIL =====
async function loadProfile(id) {
  showLoading();
  
  try {
    console.log('≈Åadujƒô profil ID:', id);
    
    const response = await fetch(`${API_URL}?id=${encodeURIComponent(id)}`, {
      headers: {
        'Content-Type': 'application/json'
        // BRAK nag≈Ç√≥wka Authorization - funkcja jest publiczna!
      }
    });
    
    console.log('Status odpowiedzi:', response.status);
    
    if (!response.ok) {
      hideLoading();
      
      if (response.status === 404) {
        showError('Nie znaleziono elektryka', 'Sprawd≈∫ czy link jest poprawny.');
        return;
      }
      
      if (response.status === 400) {
        showError('Nieprawid≈Çowe zapytanie', 'Brak lub nieprawid≈Çowy identyfikator profilu.');
        return;
      }
      
      showError('B≈ÇƒÖd serwera', 'Spr√≥buj ponownie za chwilƒô.');
      return;
    }
    
    const result = await response.json();
    console.log('Odpowied≈∫ API:', result);
    
    if (result.success) {
      hideLoading();
      renderProfile(result.data);
      updateMetaTags(result.data);
    } else {
      hideLoading();
      showError('B≈ÇƒÖd danych', result.error || 'Nie uda≈Ço siƒô za≈Çadowaƒá profilu.');
    }
  } catch (error) {
    hideLoading();
    console.error('B≈ÇƒÖd ≈Çadowania profilu:', error);
    showError('B≈ÇƒÖd po≈ÇƒÖczenia', 'Sprawd≈∫ po≈ÇƒÖczenie internetowe i spr√≥buj ponownie.');
  }
}

// ===== FUNKCJA RENDERUJƒÑCA PROFIL =====
function renderProfile(data) {
  const fullName = `${data.imie || ''} ${data.nazwisko || ''}`.trim();
  
  // 1. Nag≈Ç√≥wek
  document.getElementById("heroName").textContent = fullName || "Profil elektryka";
  document.getElementById("heroDesc").textContent = "Profil w Centralnym Rejestrze Elektryk√≥w";
  
  // 2. Linia z gwiazdkami
  document.getElementById("gwiazdkiLine").textContent = data.gwiazdki || "";
  
  // 3. Status
  const statusEl = document.getElementById("status");
  statusEl.className = "badge";
  
  const statusKey = data.status || "";
  const statusInfo = statusMap[statusKey] || statusMap[""];
  statusEl.textContent = statusInfo.text;
  statusEl.classList.add(statusInfo.class);
  
  // 4. Opis
  const zajmujeSieHTML = data.zajmujeSie || "";
  document.getElementById("opis").innerHTML = cleanOpis(zajmujeSieHTML) || 
    "<p>Us≈Çugi elektryczne - instalacje, naprawy, pomiary, doradztwo techniczne.</p>";
  
  // 5. Kontakt
  document.getElementById("email").textContent = data.email || "brak danych";
  document.getElementById("telefon").textContent = data.telefon || "brak danych";
  
  // 6. Poka≈º sekcjƒô profilu
  document.getElementById("profil").classList.remove("hidden");
  document.getElementById("brak").classList.add("hidden");
}

// ===== AKTUALIZACJA META TAG√ìW =====
function updateMetaTags(data) {
  const fullName = `${data.imie || ''} ${data.nazwisko || ''}`.trim();
  const cleanDescription = data.zajmujeSie ? 
    cleanOpis(data.zajmujeSie).replace(/<[^>]*>/g, '').substring(0, 150) + '...' : 
    'Us≈Çugi elektryczne - instalacje, naprawy, pomiary';
  
  // Title
  document.title = fullName ? `Profil elektryka: ${fullName} - OREP.pl` : 'Profil elektryka - OREP.pl';
  
  // Meta OG
  document.querySelector('meta[property="og:title"]').setAttribute('content', 
    fullName ? `Profil elektryka: ${fullName}` : 'Profil elektryka');
  document.querySelector('meta[property="og:description"]').setAttribute('content', cleanDescription);
  document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);
}

// ===== FUNKCJE POMOCNICZE UI =====
function showLoading() {
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("profil").classList.add("hidden");
  document.getElementById("brak").classList.add("hidden");
}

function hideLoading() {
  document.getElementById("loading").classList.add("hidden");
}

function showError(title, message) {
  document.getElementById("errorTitle").textContent = title;
  document.getElementById("errorMessage").textContent = message;
  document.getElementById("profil").classList.add("hidden");
  document.getElementById("brak").classList.remove("hidden");
  
  // Domy≈õlne meta tagi dla b≈Çƒôd√≥w
  document.title = title + " - OREP.pl";
  document.querySelector('meta[property="og:title"]').setAttribute('content', title);
  document.querySelector('meta[property="og:description"]').setAttribute('content', message);
}

// ===== INICJALIZACJA =====
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get("id");

if (id && id.trim() !== "") {
  console.log('ID z URL:', id);
  loadProfile(id);
} else {
  console.log('Brak ID w URL');
  showError('Brak identyfikatora profilu', 'URL powinien zawieraƒá parametr ?id=...');
  document.title = "Profil elektryka - OREP.pl";
  document.querySelector('meta[property="og:title"]').setAttribute('content', 'Og√≥lnopolski Rejestr Elektryk√≥w');
  document.querySelector('meta[property="og:description"]').setAttribute('content', 'Sprawd≈∫ profil elektryka w Og√≥lnopolskim Rejestrze Elektryk√≥w');
}

// ===== OBS≈ÅUGA PRZYCISKU UDOSTƒòPNIANIA =====
document.getElementById("shareProfileBtn").addEventListener("click", async () => {
  const heroName = document.getElementById("heroName").textContent;
  const profileUrl = window.location.href;

  if (navigator.share) {
    try {
      await navigator.share({
        title: "Profil Elektryka",
        text: `Profil elektryka ${heroName}`,
        url: profileUrl
      });
    } catch (error) {
      console.log('Udostƒôpnianie anulowane');
    }
  } else {
    // Fallback: kopiuj do schowka
    try {
      await navigator.clipboard.writeText(profileUrl);
      alert("Adres profilu zosta≈Ç skopiowany do schowka.");
    } catch (error) {
      // Ostatnia deska ratunku: prompt
      const copyText = prompt("Skopiuj ten link:", profileUrl);
      if (copyText) {
        alert("Link skopiowany!");
      }
    }
  }
});

// ===== DEBUG - dla dewelopera =====
console.log('Strona za≈Çadowana. URL:', window.location.href);
console.log('ID parametr:', id);
console.log('API URL:', API_URL);
</script>

</body>
</html>