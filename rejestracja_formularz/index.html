<!DOCTYPE html>
<html lang="pl">
<head>
  <link rel="icon" href="/favicon.png">
  <meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rejestracja – Ogólnopolski Rejestr Elektryków</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<form id="register-form">
  <input id="email" readonly>
  <input type="file" id="plik" multiple>
  <button type="submit">Zapisz</button>
  <div id="loading"></div>
  <div id="result"></div>
</form>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://tfbqqduxtsacvwfigsvt.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTE4NzcsImV4cCI6MjA4MjI2Nzg3N30.PhuNnwzQ8cZW_UyUjCxXaYAj7xCCiTnOJVd4fUtQRD8'
)

let currentUser = null

document.addEventListener('DOMContentLoaded', async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return location.href = '/logowanie'
  currentUser = user
  email.value = user.email
})

document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault()

  loading.textContent = 'Zapisywanie...'
  result.textContent = ''

  /* ===== KROK 1: sprawdź czy rekord istnieje ===== */
  const { data: existing } = await supabase
    .from('tabela_elektrykow')
    .select('id')
    .eq('email', currentUser.email)
    .maybeSingle()

  /* ===== KROK 2: ustal recordId ===== */
  let recordId
  if (existing) {
    recordId = existing.id
  } else {
    recordId = crypto.randomUUID()
  }

  /* ===== KROK 3: upload plików (krótkie nazwy) ===== */
  let plikUrls = []

  for (let file of plik.files) {
    const ext = file.name.split('.').pop().toLowerCase()
    const shortId = recordId.slice(0, 8)
    const path = `${shortId}/${Date.now()}.${ext}`

    const { error: upErr } = await supabase
      .storage.from('uprawnienia')
      .upload(path, file, { upsert: true })

    if (upErr) {
      result.textContent = upErr.message
      return
    }

    const { data } = await supabase
      .storage.from('uprawnienia')
      .createSignedUrl(path, 3600)

    plikUrls.push(data.signedUrl)
  }

  const payload = {
    id: recordId,
    email: currentUser.email,
    plik: plikUrls.join(',')
  }

  /* ===== KROK 4: insert / update na tym samym ID ===== */
  let error
  if (existing) {
    const { error: e1 } = await supabase
      .from('tabela_elektrykow')
      .update(payload)
      .eq('id', recordId)
    error = e1
  } else {
    const { error: e2 } = await supabase
      .from('tabela_elektrykow')
      .insert(payload)
    error = e2
  }

  loading.textContent = ''

  if (error) {
    result.textContent = error.message
    return
  }

  /* ===== KROK 5: GOTOWE ===== */
  result.textContent = 'Zapisano poprawnie'
})
</script>
</body>
</html>
