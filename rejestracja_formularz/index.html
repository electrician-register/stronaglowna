<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload plików</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<form id="register-form">
  <label>Email</label><br>
  <input id="email" type="email" readonly><br><br>

  <label>Pliki</label><br>
  <input type="file" id="plik" multiple><br><br>

  <button type="submit">Zapisz</button>
</form>

<p id="loading"></p>
<p id="result"></p>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://tfbqqduxtsacvwfigsvt.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTE4NzcsImV4cCI6MjA4MjI2Nzg3N30.PhuNnwzQ8cZW_UyUjCxXaYAj7xCCiTnOJVd4fUtQRD8'
)

let currentUser = null

document.addEventListener('DOMContentLoaded', async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    alert('Brak logowania')
    return
  }
  currentUser = user
  document.getElementById('email').value = user.email
})

document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault()

  loading.textContent = 'Zapisywanie...'
  result.textContent = ''

  /* 1️⃣ sprawdzenie rekordu */
  const { data: existing } = await supabase
    .from('tabela_elektrykow')
    .select('id')
    .eq('email', currentUser.email)
    .maybeSingle()

  /* 2️⃣ ID rekordu */
  const recordId = existing?.id ?? crypto.randomUUID()

  /* 3️⃣ upload plików */
  let urls = []

  for (const file of plik.files) {
    const ext = file.name.split('.').pop()
    const shortId = recordId.slice(0, 8)
    const path = `${shortId}/${Date.now()}.${ext}`

    const { error } = await supabase
      .storage.from('uprawnienia')
      .upload(path, file, { upsert: true })

    if (error) {
      result.textContent = error.message
      loading.textContent = ''
      return
    }

    const { data } = await supabase
      .storage.from('uprawnienia')
      .createSignedUrl(path, 3600)

    urls.push(data.signedUrl)
  }

  /* 4️⃣ zapis do bazy */
  const payload = {
    id: recordId,
    email: currentUser.email,
    plik: urls.join(',')
  }

  const { error: dbError } = existing
    ? await supabase.from('tabela_elektrykow').update(payload).eq('id', recordId)
    : await supabase.from('tabela_elektrykow').insert(payload)

  loading.textContent = ''

  if (dbError) {
    result.textContent = dbError.message
    return
  }

  result.textContent = 'Zapisano poprawnie'
})
</script>

</body>
</html>
