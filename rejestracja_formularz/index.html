<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rejestracja ‚Äì Og√≥lnopolski Rejestr Elektryk√≥w</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; display: flex; justify-content: center; padding: 20px; }
    .form-wrapper { display: flex; flex-direction: column; align-items: flex-start; width: 100%; max-width: 600px; }
    .avatar-btn { width: 64px; height: 64px; border-radius: 50%; background: #2b6cb0; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; margin-bottom: 15px; cursor: default; }
    form { background-color: #ffffff; padding: 30px 40px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; }
    h2 { text-align: center; color: #333; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; color: #555; font-weight: 600; }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; transition: border 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: #4CAF50; outline: none; }
    textarea { resize: vertical; min-height: 80px; }
    input[type="file"] { margin-top: 10px; }
    button { margin-top: 20px; width: 100%; padding: 12px; background-color: #4CAF50; color: white; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; }
    button:hover { background-color: #45a049; }
    #result { font-weight: bold; padding: 10px; margin-top: 15px; text-align: center; border-radius: 6px; }
    .success { background-color: #4CAF50; color: white; }
    .error { background-color: #f44336; color: white; }
    #loading { display: none; text-align: center; color: #333; font-weight: bold; margin-top: 10px; }
  </style>
</head>

<body>

  <div class="form-wrapper">
    <button class="avatar-btn" id="avatarBtn">‚ö°</button>

    <form id="register-form">
      <h2>Rejestracja</h2>

      <label for="imie">Imiƒô:</label>
      <input type="text" id="imie" name="imie" required oninput="this.value = this.value.toUpperCase(); updateAvatar();">

      <label for="nazwisko">Nazwisko:</label>
      <input type="text" id="nazwisko" name="nazwisko" required oninput="this.value = this.value.toUpperCase(); updateAvatar();">

      <label for="miasto">Miasto:</label>
      <input type="text" id="miasto" name="miasto">

      <label for="wojewodztwo">Wojew√≥dztwo:</label>
      <input type="text" id="wojewodztwo" name="wojewodztwo">

      <label for="nrE">Nr uprawnie≈Ñ E:</label>
      <textarea id="nrE" name="nrE"></textarea>
     
      <label for="nrEPomiary">Nr uprawnie≈Ñ E z pomiarami:</label>
      <textarea id="nrEPomiary" name="nrEPomiary"></textarea>

      <label for="nrD">Nr uprawnie≈Ñ D:</label>
      <textarea id="nrD" name="nrD"></textarea>

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" readonly>

      <label for="telefon">Telefon:</label>
      <input type="tel" id="telefon" name="telefon">

      <label for="zajmujeSie">Zajmuje siƒô:</label>
      <textarea id="zajmujeSie" name="zajmujeSie"></textarea>

      <label for="plik">Za≈ÇƒÖcz skan uprawnie≈Ñ:</label>
      <input type="file" id="plik" name="plik" accept="*/*" multiple>

      <button type="submit">Zarejestruj</button>

      <p id="result"></p>
      <p id="loading">Trwa rejestracja, proszƒô czekaƒá...</p>
    </form>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://tfbqqduxtsacvwfigsvt.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmYnFxZHV4dHNhY3Z3Zmlnc3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTE4NzcsImV4cCI6MjA4MjI2Nzg3N30.PhuNnwzQ8cZW_UyUjCxXaYAj7xCCiTnOJVd4fUtQRD8'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const avatarBtn = document.getElementById('avatarBtn')

    // üîπ Pobranie tokenu z URL
    const params = new URLSearchParams(window.location.search)
    const token = params.get('token')

    function updateAvatar() {
      const imie = document.getElementById('imie').value
      const nazwisko = document.getElementById('nazwisko').value
      if (imie || nazwisko) {
        avatarBtn.textContent = (imie[0] || 'üë§').toUpperCase() + (nazwisko[0] || '').toUpperCase()
      } else {
        avatarBtn.textContent = '‚ö°'
      }
    }

    async function fetchUserData() {
      if (!token) return
      const { data, error } = await supabase
        .from('users')
        .select('imie, nazwisko, email')
        .eq('token', token)
        .single()

      if (error) {
        console.error('B≈ÇƒÖd pobierania danych:', error.message)
        return
      }

      if (data) {
        document.getElementById('imie').value = data.imie
        document.getElementById('nazwisko').value = data.nazwisko
        document.getElementById('email').value = data.email
        updateAvatar()
      }
    }

    fetchUserData()

    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault()
      document.getElementById('loading').style.display = 'block'

      const imie = document.getElementById('imie').value
      const nazwisko = document.getElementById('nazwisko').value
      const miasto = document.getElementById('miasto').value
      const wojewodztwo = document.getElementById('wojewodztwo').value
      const nrE = document.getElementById('nrE').value
      const nrEPomiary = document.getElementById('nrEPomiary').value
      const nrD = document.getElementById('nrD').value
      const email = document.getElementById('email').value
      const telefon = document.getElementById('telefon').value
      const zajmujeSie = document.getElementById('zajmujeSie').value

      const plikInput = document.getElementById('plik')
      let plikUrls = []

      if (plikInput.files.length > 0) {
        for (let i = 0; i < plikInput.files.length; i++) {
          const file = plikInput.files[i]
          const filePath = `permissions/${Date.now()}_${i}_${file.name}`

          const { error: uploadError } = await supabase.storage
            .from('attachments')
            .upload(filePath, file)

          if (uploadError) {
            document.getElementById('loading').style.display = 'none'
            const result = document.getElementById('result')
            result.textContent = 'B≈ÇƒÖd przesy≈Çania pliku: ' + uploadError.message
            result.classList.add('error')
            return
          }

          const { data: publicUrlData } = supabase.storage
            .from('attachments')
            .getPublicUrl(filePath)

          plikUrls.push(publicUrlData.publicUrl)
        }
      }

      const plikiString = plikUrls.join(',')

      const { error } = await supabase
        .from('users')
        .update({
          miasto, wojewodztwo, nrE, nrEPomiary, nrD, telefon, zajmujeSie, plik: plikiString, status: 'completed'
        })
        .eq('token', token)

      const result = document.getElementById('result')
      result.classList.remove('success', 'error')
      document.getElementById('loading').style.display = 'none'

      if (error) {
        result.textContent = 'B≈ÇƒÖd: ' + error.message
        result.classList.add('error')
      } else {
        window.location.href = 'https://orep.pl/logowanie'
      }
    })
  </script>

</body>
</html>
