document.addEventListener('DOMContentLoaded', async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return window.location.href = '/logowanie'

  currentUser = user
  email.value = user.email

  const { data } = await supabase.from('tabela_elektrykow')
    .select('*')
    .eq('email', user.email)
    .single()

  if (data) {
    document.getElementById('form-title').textContent = 'Aktualizacja danych'
    document.getElementById('submit-btn').textContent = 'Zapisz zmiany'

    fields.forEach(f => data[f] && (document.getElementById(f).value = data[f]))

    if (data.wojewodztwo) await loadWojewodztwa(data.wojewodztwo)
    if (data.miasto) document.getElementById('miasto').value = data.miasto

    // Ustawienie pól dat ważności
    if (data.nrE) {
      nrEValidLabel.style.display = 'block'
      nrEValidTo.style.display = 'block'
      nrEValidTo.value = data.nrE_valid_to || ''
    }
    if (data.nrEPomiary) {
      nrEPomiaryValidLabel.style.display = 'block'
      nrEPomiaryValidTo.style.display = 'block'
      nrEPomiaryValidTo.value = data.nrEPomiary_valid_to || ''
    }
    if (data.nrD) {
      nrDValidLabel.style.display = 'block'
      nrDValidTo.style.display = 'block'
      nrDValidTo.value = data.nrD_valid_to || ''
    }
  } else {
    loadWojewodztwa()
  }
})
